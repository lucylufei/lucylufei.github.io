<!DOCTYPE html>
<html>
<body>

<div>
    <p id="result">No information to display...</p>

    <button class="btn">
        Manual Check
    </button>
    <button id="stop">
        Stop
    </button>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
    const APIKEY = "5pHUHcMbP5nU6jDfq45y";
    const BUSSTOP = "53343"
    const URL = "https://api.translink.ca/rttiapi/v1/stops/" + BUSSTOP + "/estimates?apikey=" + APIKEY + "&count=2&timeframe=30";
    const minCount = 6;

    function checkBus(){
        $.ajax({
            accepts: "application/JSON",
            url: URL,
            type: "GET",
            contentType: "application/JSON",
            cache: false,
            success: function(result){
                var parsed_results = JSON.parse(result);
                console.log(parsed_results);

                $("#result").html("");
                var bus_arriving = false;
                parsed_results.forEach(function(bus) {
                    bus.Schedules.forEach(function(sch) {
                        if (sch.ScheduleStatus != "*" && sch.ExpectedCountdown < minCount) {
                            bus_arriving = true;
                            $("#result").append("BUS: " + bus.RouteNo);
                            $("#result").append("<br>");       

                            if (sch.ExpectedCountdown < 0) {
                                $("#result").append("BUS ARRIVING 'NOW'");
                            }                    
                            else {
                                navigator.vibrate(200);
                                $("#result").append("TIME: " + sch.ExpectedLeaveTime);
                                $("#result").append("<br>-------------------------<br>"); 
                            }
                        }
                    });
                }); 

                if (bus_arriving === false) {
                    $("#result").html("No bus coming...");
                }
            },
        });
    }

    var interval_id;

    $(document).ready(function(){
        interval_id = setInterval(checkBus, 1 * 60 * 1000);
        $("#stop").click(function(){
            clearInterval(interval_id);
        })
    });

    $(document).ready(function(){
        $(".btn").click(checkBus);
    });

</script>

</body>
</html>
